import re
import os
import dspy
import ollama

# åˆå§‹åŒ– dspy æœ¬åœ°æ¨¡åž‹ï¼ˆåªåšä¸€æ¬¡ï¼‰
lm = dspy.Ollama(
    model="qwen:14b",                  # ä½ æœ¬åœ° Ollama æ¨¡åž‹
    base_url="http://localhost:11434", # é»˜è®¤ Ollama å¯åŠ¨åœ°å€
    temperature=0.2
)
dspy.configure(lm=lm)

# å®šä¹‰è¯­ä¹‰é—®ç­”æ¨¡å—
qa_module = dspy.Predict("context, question -> answer")


# ä¸»é—®ç­”å‡½æ•°
def rag_ask(question: str, context_str, top_k=10):
    result = qa_module(context=context_str, question=question)
    return result.answer

# CLI æµ‹è¯•å…¥å£
if __name__ == "__main__":
    vault ="""
Aè½®èˆ¹ä½œä¸ºåº”é‚€å‚å±•èˆ¹è‰‡ï¼Œå°†äºŽèˆªæµ·æ—¥å½“å¤©åœé ç¼æµ·ï¼Œå¼€å±•å¼€æ”¾æ—¥ã€ç§‘æ™®è®²è§£ä¸Žç»¿è‰²èˆªæµ·å€¡è®®å‘å¸ƒã€‚
ä¸ºæ¥å¹´æ˜¥å­£è¿è¥åšå‡†å¤‡ã€‚
äº”æœˆä¸­æ—¬å°†æœ‰â€œæˆ‘ä»¬ä¸€èµ·åŽ»çœ‹æµ·â€å®£ä¼ æ´»åŠ¨åœ¨å®æ³¢å¯åŠ¨ï¼Œå…­æœˆä¸­æ—¬å°†èµ´ä¹æ±Ÿå±•å¼€æ±Ÿæ²³æ¹–æµ·çœ‹ä¸­å›½çŽ°åœºæŽ¨ä»‹ä¼š([äº¤é€šè¿è¾“éƒ¨][1])ã€‚
2025å¹´7æœˆ15æ—¥â€”â€”ç‰©èµ„ä¾›åº”ä¿éšœä»»åŠ¡å®žæˆ˜æ¨¡ä»¿â€œå¤©èˆŸä¹å·â€å¿«é€Ÿè¡¥ç»™æ¨¡å¼ï¼ŒAè½®èˆ¹é¦–æ¬¡æ‰§è¡Œç±»ä¼¼åº”æ€¥è¡¥ç»™ä»»åŠ¡ï¼Œä»Žä¸Šæµ·ç«é€Ÿè¿é€6å¨é«˜ä»·å€¼åŒ»ç–—ç‰©èµ„åˆ°æµ·å—ï¼Œå±•ç¤ºä¸‰å°æ—¶å†…â€œå‡ºæ¸¯â†’åœé â†’å¸è´§â€ç´§æ€¥åº”å˜èƒ½åŠ›([ç»´åŸºç™¾ç§‘][11])ã€‚
2025å¹´11æœˆâ€”â€”å†¬å­£å†…éƒ¨åŸ¹è®­ä¸Žå…¬ä¼—å¼€æ”¾11æœˆé¦–æœˆï¼ŒAè½®èˆ¹åœ¨ä¸Šæµ·æ¸¯åŒºæ–œé ï¼Œå¼€å±•å…¨å¹´æœ€åŽä¸€è½®â€œèˆ¹å‘˜åŸ¹è®­+å…¬ä¼—å¼€æ”¾æ—¥â€æ´»åŠ¨ï¼ŒåŒ…æ‹¬æ¨¡æ‹Ÿåº”æ€¥æ’¤ç¦»ã€å®‰å…¨æ¼”ç»ƒã€å¼•æ“Žå®¤æŽ¢ç§˜ç­‰ä¸»é¢˜ã€‚
**ç¬¬ä¸€ç¯‡ | èˆªè¡Œä¸Žå‘å±•ï¼šä¸€è‰˜èˆ¹çš„ä¸€å¹´è½®å›ž**2025å¹´1æœˆâ€”â€”æ–°å¹´é¦–èˆªæ¯å¹´å¹´åˆï¼ŒAè½®èˆ¹ï¼ˆå‡è®¾èˆ¹åï¼‰ä»Žä¸Šæµ·å´æ·žå£å›½é™…æ¸¯å‡ºå‘ï¼Œå¼€å¯å¹´åº¦é¦–èˆªï¼Œå¼€å¯â€œæ–°å¹´å·¡èˆªâ€ç³»åˆ—æ´»åŠ¨ã€‚
åŒæ—¶å‘å¸ƒæ¬¡å¹´è¿è¥è®¡åˆ’ï¼Œå¼€å¯ä¸‹ä¸€è½®å‘¨æœŸã€‚
2025å¹´12æœˆâ€”â€”å¹´åº¦æ€»ç»“å¤§ä¼šAè½®èˆ¹äºŽæœ¬æœˆå›žæ¸¯ï¼Œä¸¾åŠžâ€œå¹´åº¦èˆªè¡Œæ€»ç»“å¤§ä¼šâ€ï¼ŒæŠ«éœ²å…¨å¹´ç»¿è‰²èˆªè¿ã€å…¬ç›Šå½±å“ä¸ŽæŠ€æœ¯é©æ–°æˆæžœï¼Œå‘æ”¿åºœéƒ¨é—¨ä¸Žåˆä½œæ–¹æ±‡æŠ¥ã€‚
2025å¹´5æœˆâ€”â€”èˆªæµ·æ—¥æ´»åŠ¨æ¯å¹´7æœˆ11æ—¥ä¸ºä¸­å›½èˆªæµ·æ—¥ï¼Œä»Šå¹´ä¸»é¢˜â€œç»¿è‰²èˆªæµ·ï¼Œå‘æ–°å›¾å¼ºâ€ï¼Œä½†ç›¸å…³å®£ä¼ ä¸Žè®ºå›æ´»åŠ¨è‡ª5æœˆèµ·å³å¼€å§‹é¢„çƒ­ã€‚
**æœ€æ–°æŠ¥é“æ¦‚è¦*** **å†…æ²³ä¸Žèˆªæµ·åŒé©±åŠ¨**ï¼š2025å¹´â€œæˆ‘ä»¬ä¸€èµ·åŽ»çœ‹æµ·â€çº¿ä¸Šçº¿ä¸‹æŽ¨å¹¿æ´»åŠ¨ï¼Œçº¿ä¸‹5æœˆå¯åŠ¨äºŽå®æ³¢ï¼Œ6æœˆèµ°è¿›ä¹æ±Ÿï¼Œ7æœˆèˆªæµ·æ—¥åœ¨ç¼æµ·ä¸»åŠžè®ºå›([äº¤é€šè¿è¾“éƒ¨][1])ã€‚
2025å¹´3æœˆâ€”â€”æ˜¥å­£æµ·è¯•æ˜¥åˆ†å‰åŽï¼ŒAè½®èˆ¹å¯åŠ¨æ˜¥å­£ä¾‹è¡Œæµ·è¯•ï¼Œä»Žä¸Šæµ·å‡ºå‘ï¼Œå‰å¾€ä¸œæµ·åŠé»„æµ·æµ·åŸŸï¼Œè¿›è¡ŒåŠ¨åŠ›ç³»ç»Ÿã€å¯¼èˆªç³»ç»ŸåŠèˆ¹å‘˜åº”æ€¥å®‰å…¨æ¼”ç»ƒã€‚
2025å¹´9æœˆâ€”â€”ç§‹å­£è´§ç‰©è¿è¾“å­£è¿›å…¥ä¸‰å­£åº¦æœ«ï¼ŒAè½®èˆ¹è½¬å‘è´§ç‰©æµä¸šåŠ¡ï¼Œä»Žä¸Šæµ·ç»ç”±å®æ³¢ã€å¹¿å·žå¾€è¿”ä¸œå—äºšï¼Œæ‰§è¡Œâ€œä¸€å¸¦ä¸€è·¯â€ç»¿è‰²èˆªè¿è¡¥ç»™ä»»åŠ¡ï¼Œå±•ç¤ºæ–°èƒ½æºæŽ¨è¿›æŠ€æœ¯åœ¨å›½é™…èˆªçº¿ä¸Šçš„åº”ç”¨ã€‚
æ—¨åœ¨æ£€æµ‹è®¾å¤‡ç¨³å®šæ€§ï¼Œä¸ºå…¨å¹´å®‰å…¨è¿è¡Œå¥ å®šåŸºç¡€ã€‚
2025å¹´12æœˆâ€”â€”æ™ºèƒ½èˆ¹èˆ¶å‘å±•è®ºå›å¹´åº•ï¼ŒAè½®èˆ¹ä¸»åŠžâ€œæ™ºèƒ½ä¸Žç»¿è‰²èˆ¹èˆ¶å‘å±•â€å°åž‹è®ºå›ï¼Œèµ´å®æ³¢æˆ–ä¸Šæµ·å¬å¼€ï¼Œé‚€è¯·ç ”ç©¶æœºæž„ã€ç›‘ç®¡æœºæž„åŠèˆªè¿ä¼ä¸šä»£è¡¨å‡ºå¸­ï¼Œå±•ç¤ºå¹´åº¦æˆæžœï¼šè‡ªä¸»å¯¼èˆªã€ç½‘ç»œé˜²æŠ¤ã€ç»¿è‰²å‡æŽ’ã€å¿«é€Ÿè¡¥ç»™ã€‚
2025å¹´10æœˆâ€”â€”å¤–æ´å®‰å…¨ååŠ©Aè½®èˆ¹æŽ¥æ”¶é‡åº†å¤§å­¦ç­‰é«˜æ ¡é‚€è¯·ï¼Œèµ´ä¸œå—äºšä¸€æ¸¯å¼€å±•èˆªè¿å®‰å…¨ä¸Žç½‘ç»œç›‘ç®¡å‹å¥½äº¤æµã€‚
2025å¹´4æœˆâ€”â€”ç½‘ç»œå®‰å…¨ä¸“é¡¹æ¼”ç»ƒæ˜¥æœ«ï¼ŒAè½®èˆ¹è¿›è¡Œâ€œæµ·ä¸Šç½‘ç»œå®‰å…¨â€ä¸“é¡¹éƒ¨ç½²ï¼Œæ¨¡æ‹ŸGPSæ¬ºéª—ã€èˆ¹èˆ¶ç³»ç»Ÿé­é‡å‹’ç´¢è½¯ä»¶ç­‰å®žæˆ˜æ€§æ”»å‡»ï¼Œå®Œæˆæ–°åž‹åº”å¯¹æœºåˆ¶çš„æ¼”ç»ƒã€‚
* **å´”è´¤çº§é©±é€èˆ°åŠ¨æ€**ï¼šæœé²œâ€œå´”è´¤å·â€é©±é€èˆ°äºŽ4æœˆ25æ—¥ä¸‹æ°´ï¼Œå¹¶äºŽ5æœˆ21æ—¥ä¸‹æ°´äº‹æ•…åŽè¿›å…¥ä¿®å¤ï¼Œ6æœˆå‰æ¢å¤æµ®åŠçŠ¶æ€([ç»´åŸºç™¾ç§‘][13])ã€‚
2025å¹´8æœˆâ€”â€”çŽ¯ä¿æ€§èƒ½è¯„ä¼°å·¡èˆªè¿›è¡Œä¸€æ¬¡ä¸ºæœŸä¸¤å‘¨çš„â€œç¢³æŽ’æ”¾æµ‹è¯•å·¡èˆªâ€ï¼Œé…åˆçŽ¯ä¿æœºæž„è¯„ä¼°èˆ¹èˆ¶æ–°åž‹æ··åˆåŠ¨åŠ›å‡æŽ’æ•ˆæžœã€‚
* **çˆ±è¾¾Â·é­”éƒ½å·è¿è¥å›žæš–**ï¼šå›½äº§å¤§åž‹æ¸¸è½®â€œçˆ±è¾¾Â·é­”éƒ½å·â€è‡ªå¹´åˆèµ·æ¢å¤ä¸œåŒ—äºšèˆªçº¿ï¼Œå…·å¤‡5Gè¦†ç›–ã€æ°´ä¸Šä¹å›­ç­‰è®¾æ–½ï¼Œå¹¶æŒç»­å‘å¸ƒé‚®è½®ç»¿è‰²èˆªçº¿è®¡åˆ’([ç»´åŸºç™¾ç§‘][14])ã€‚
ç»“åˆè¿‘æœŸçº¢æµ·å®‰å…¨äº‹ä»¶ï¼Œåˆ†äº«å®‰å…¨é˜²æŠ¤ç»éªŒ([ç»´åŸºç™¾ç§‘][6])ã€‚
"""

    while True:
        user_input = input("\nè¯·è¾“å…¥ä½ çš„é—®é¢˜ï¼ˆè¾“å…¥ quit é€€å‡ºï¼‰ï¼š\n> ")
        if user_input.strip().lower() in ["quit", "exit"]:
            break
        answer = rag_ask(user_input, vault)
        print("\nðŸ§  æ¨¡åž‹å›žç­”ï¼š\n", answer)
