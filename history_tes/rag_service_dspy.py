import re
import os
import dspy
import ollama

# 初始化 dspy 本地模型（只做一次）
lm = dspy.Ollama(
    model="qwen:14b",                  # 你本地 Ollama 模型
    base_url="http://localhost:11434", # 默认 Ollama 启动地址
    temperature=0.2
)
dspy.configure(lm=lm)

# 定义语义问答模块
qa_module = dspy.Predict("context, question -> answer")


# 主问答函数
def rag_ask(question: str, context_str, top_k=10):
    result = qa_module(context=context_str, question=question)
    return result.answer

# CLI 测试入口
if __name__ == "__main__":
    vault ="""
A轮船作为应邀参展船艇，将于航海日当天停靠琼海，开展开放日、科普讲解与绿色航海倡议发布。
为来年春季运营做准备。
五月中旬将有“我们一起去看海”宣传活动在宁波启动，六月中旬将赴九江展开江河湖海看中国现场推介会([交通运输部][1])。
2025年7月15日——物资供应保障任务实战模仿“天舟九号”快速补给模式，A轮船首次执行类似应急补给任务，从上海火速运送6吨高价值医疗物资到海南，展示三小时内“出港→停靠→卸货”紧急应变能力([维基百科][11])。
2025年11月——冬季内部培训与公众开放11月首月，A轮船在上海港区斜靠，开展全年最后一轮“船员培训+公众开放日”活动，包括模拟应急撤离、安全演练、引擎室探秘等主题。
**第一篇 | 航行与发展：一艘船的一年轮回**2025年1月——新年首航每年年初，A轮船（假设船名）从上海吴淞口国际港出发，开启年度首航，开启“新年巡航”系列活动。
同时发布次年运营计划，开启下一轮周期。
2025年12月——年度总结大会A轮船于本月回港，举办“年度航行总结大会”，披露全年绿色航运、公益影响与技术革新成果，向政府部门与合作方汇报。
2025年5月——航海日活动每年7月11日为中国航海日，今年主题“绿色航海，向新图强”，但相关宣传与论坛活动自5月起即开始预热。
**最新报道概要*** **内河与航海双驱动**：2025年“我们一起去看海”线上线下推广活动，线下5月启动于宁波，6月走进九江，7月航海日在琼海主办论坛([交通运输部][1])。
2025年3月——春季海试春分前后，A轮船启动春季例行海试，从上海出发，前往东海及黄海海域，进行动力系统、导航系统及船员应急安全演练。
2025年9月——秋季货物运输季进入三季度末，A轮船转向货物流业务，从上海经由宁波、广州往返东南亚，执行“一带一路”绿色航运补给任务，展示新能源推进技术在国际航线上的应用。
旨在检测设备稳定性，为全年安全运行奠定基础。
2025年12月——智能船舶发展论坛年底，A轮船主办“智能与绿色船舶发展”小型论坛，赴宁波或上海召开，邀请研究机构、监管机构及航运企业代表出席，展示年度成果：自主导航、网络防护、绿色减排、快速补给。
2025年10月——外援安全协助A轮船接收重庆大学等高校邀请，赴东南亚一港开展航运安全与网络监管友好交流。
2025年4月——网络安全专项演练春末，A轮船进行“海上网络安全”专项部署，模拟GPS欺骗、船舶系统遭遇勒索软件等实战性攻击，完成新型应对机制的演练。
* **崔贤级驱逐舰动态**：朝鲜“崔贤号”驱逐舰于4月25日下水，并于5月21日下水事故后进入修复，6月前恢复浮吊状态([维基百科][13])。
2025年8月——环保性能评估巡航进行一次为期两周的“碳排放测试巡航”，配合环保机构评估船舶新型混合动力减排效果。
* **爱达·魔都号运营回暖**：国产大型游轮“爱达·魔都号”自年初起恢复东北亚航线，具备5G覆盖、水上乐园等设施，并持续发布邮轮绿色航线计划([维基百科][14])。
结合近期红海安全事件，分享安全防护经验([维基百科][6])。
"""

    while True:
        user_input = input("\n请输入你的问题（输入 quit 退出）：\n> ")
        if user_input.strip().lower() in ["quit", "exit"]:
            break
        answer = rag_ask(user_input, vault)
        print("\n🧠 模型回答：\n", answer)
